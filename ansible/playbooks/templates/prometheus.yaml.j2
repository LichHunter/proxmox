global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  # Scrape Prometheus itself
  - job_name: 'prometheus'
    scheme: https
    tls_config:
      insecure_skip_verify: true
    static_configs:
      - targets: ['localhost:9090']

  # Scrape the specific LXC containers defined in playbook
  - job_name: 'homelab_services'
    scheme: https
    static_configs:
      - targets:
{% for target in scrape_targets %}
{% if target is mapping %}
        - '{{ target.name }}.{{ scrape_target_hostname }}:{{ target.port | default(9100) }}'
{% else %}
        - '{{ target }}.{{ scrape_target_hostname }}:9100'
{% endif %}
{% endfor %}

  # Scrape Nginx metrics (enabled by nginx_metrics_enabled variable)
{% if nginx_metrics_enabled | default(false) %}
  - job_name: 'nginx_metrics'
    scheme: http
    static_configs:
      - targets:
        - 'nginx.{{ scrape_target_hostname }}:9113'
{% endif %}

  # Blackbox Exporter - probe HTTPS endpoints and monitor TLS certificates
  - job_name: 'blackbox_https_2xx'
    metrics_path: /probe
    params:
      module: [https_2xx]
    static_configs:
      - targets:
{% if blackbox_exporter_https_targets is defined %}
{% for target in blackbox_exporter_https_targets %}
        - '{{ target }}'
{% endfor %}
{% endif %}
    relabel_configs:
      # Use the target address as the __param_target parameter
      - source_labels: [__address__]
        target_label: __param_target
      # Use the target address as the instance label
      - source_labels: [__param_target]
        target_label: instance
      # Actually probe via the blackbox exporter running on localhost
      - target_label: __address__
        replacement: localhost:9115

  # Scrape Blackbox Exporter metrics itself
  - job_name: 'blackbox_exporter'
    scheme: http
    static_configs:
      - targets:
        - 'localhost:9115'
