---
- name: Configure Prometheus
  hosts: prometheus
  gather_facts: true
  become: false
  roles:
    - zsh

  vars:
    service_user: "prometheus"
    service_group: "prometheus"
    service_name: "prometheus.service"
    cert_folder: "/etc/prometheus/certs"
    cert_filename: "prometheus.homelab.lan"
    domain: "homelab.com"
    scrape_target_hostname: "homelab.lan"
    prometheus_version: "2.55.1"
    prometheus_arch: "linux-amd64"
    prometheus_install_dir: "/usr/local/bin"
    prometheus_config_dir: "/etc/prometheus"
    prometheus_data_dir: "/var/lib/prometheus"
    nginx_metrics_enabled: true
    scrape_targets:
      - "nginx"
      - name: "authentik"
        port: 9300

  tasks:
    - name: Check if Vault root CA already exists
      ansible.builtin.stat:
        path: /usr/local/share/ca-certificates/vault-root-ca.crt
      register: root_ca_stat

    - name: Download Vault root CA certificate (Internal LAN)
      when: not root_ca_stat.stat.exists
      ansible.builtin.uri:
        url: "https://vault.homelab.lan:8200/v1/root_ca/ca/pem"
        method: GET
        validate_certs: false
        return_content: true
        dest: /usr/local/share/ca-certificates/vault-root-ca.crt

    - name: Update CA certificates
      when: not root_ca_stat.stat.exists
      ansible.builtin.command:
        cmd: update-ca-certificates
      changed_when: true

    - name: Fetch AppRole role_id from Vault
      ansible.builtin.uri:
        url: "https://vault.homelab.lan:8200/v1/auth/approle/role/prometheus/role-id"
        method: GET
        headers:
          X-Vault-Token: "{{ vault_token }}"
        validate_certs: true
        return_content: true
      register: prometheus_role_id_response

    - name: Generate AppRole secret_id from Vault
      ansible.builtin.uri:
        url: "https://vault.homelab.lan:8200/v1/auth/approle/role/prometheus/secret-id"
        method: POST
        headers:
          X-Vault-Token: "{{ vault_token }}"
        validate_certs: false
        return_content: true
      register: prometheus_secret_id_response

    - name: Configure Vault Agent for Prometheus Certificate
      ansible.builtin.include_role:
        name: vault_agent
      vars:
        vault_agent_common_name: "prometheus.homelab.lan"
        vault_agent_cert_filename: "{{ cert_filename }}"
        vault_agent_cert_folder: "{{ cert_folder }}"
        vault_agent_reload_service: "{{ service_name }}"
        vault_agent_role_id: "{{ prometheus_role_id_response.json.data.role_id }}"
        vault_agent_secret_id: "{{ prometheus_secret_id_response.json.data.secret_id }}"
        vault_agent_service_user: "{{ service_user }}"
        vault_agent_service_group: "{{ service_group }}"

    - name: Check if Prometheus group exists
      ansible.builtin.getent:
        database: group
        key: "{{ service_group }}"
        fail_key: false
      register: prometheus_group_check

    - name: Create Prometheus system group
      ansible.builtin.group:
        name: "{{ service_group }}"
        system: true
        state: present
      when: prometheus_group_check.ansible_facts.getent_group[service_group] is not defined

    - name: Check if Prometheus user exists
      ansible.builtin.getent:
        database: passwd
        key: "{{ service_user }}"
        fail_key: false
      register: prometheus_user_check

    - name: Create Prometheus system user
      ansible.builtin.user:
        name: "{{ service_user }}"
        group: "{{ service_group }}"
        system: true
        shell: /usr/sbin/nologin
        home: "{{ prometheus_data_dir }}"
        create_home: false
        state: present
      when: prometheus_user_check.ansible_facts.getent_passwd[service_user] is not defined

    - name: Create Prometheus directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ service_user }}"
        group: "{{ service_group }}"
        mode: '0755'
      loop:
        - "{{ prometheus_config_dir }}"
        - "{{ prometheus_data_dir }}"
        - "{{ cert_folder }}"

    - name: Download Prometheus binary
      ansible.builtin.get_url:
        url: "https://github.com/prometheus/prometheus/releases/download/v{{ prometheus_version }}/prometheus-{{ prometheus_version }}.{{ prometheus_arch }}.tar.gz"
        dest: "/tmp/prometheus-{{ prometheus_version }}.tar.gz"
        mode: '0644'

    - name: Extract Prometheus binary
      ansible.builtin.unarchive:
        src: "/tmp/prometheus-{{ prometheus_version }}.tar.gz"
        dest: "/tmp"
        remote_src: true
        creates: "/tmp/prometheus-{{ prometheus_version }}.{{ prometheus_arch }}/prometheus"

    - name: Install Prometheus binaries
      ansible.builtin.copy:
        src: "/tmp/prometheus-{{ prometheus_version }}.{{ prometheus_arch }}/{{ item }}"
        dest: "{{ prometheus_install_dir }}/{{ item }}"
        owner: root
        group: root
        mode: '0755'
        remote_src: true
      loop:
        - prometheus
        - promtool

    - name: Clean up downloaded files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "/tmp/prometheus-{{ prometheus_version }}.tar.gz"
        - "/tmp/prometheus-{{ prometheus_version }}.{{ prometheus_arch }}"

    - name: Configure Prometheus
      ansible.builtin.template:
        src: templates/prometheus.yaml.j2
        dest: "{{ prometheus_config_dir }}/prometheus.yaml"
        owner: "{{ service_user }}"
        group: "{{ service_group }}"
        mode: '0644'
      notify: restart_prometheus

    - name: Configure Prometheus Web
      ansible.builtin.template:
        src: templates/prometheus-web.yaml.j2
        dest: "{{ prometheus_config_dir }}/web-config.yaml"
        owner: "{{ service_user }}"
        group: "{{ service_group }}"
        mode: '0644'
      notify: restart_prometheus

    - name: Install Prometheus systemd service
      ansible.builtin.template:
        src: templates/prometheus.service.j2
        dest: /etc/systemd/system/prometheus.service
        owner: root
        group: root
        mode: '0644'
      notify: restart_prometheus

    - name: Ensure Prometheus is enabled and running
      ansible.builtin.systemd:
        name: prometheus
        state: started
        enabled: true

  handlers:
    - name: restart_prometheus
      ansible.builtin.systemd:
        name: prometheus
        state: restarted
        daemon_reload: true
