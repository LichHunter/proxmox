---
- name: Configure Nginx with Vault Agent
  hosts: nginx
  gather_facts: true
  become: false
  roles:
    - zsh

  vars:
    cert_common_name: "*.homelab.com"
    cert_filename: "wildcard.homelab.com"
    nginx_proxy_services:
      - server_name: vault.homelab.com
        backend_host: vault.homelab.lan
        backend_port: 8200
        backend_protocol: https

      - server_name: grafana.homelab.com
        backend_host: grafana.homelab.lan
        backend_port: 3000
        backend_protocol: https

      - server_name: authentik.homelab.com
        backend_host: authentik.homelab.lan
        backend_port: 9443
        backend_protocol: https

      - server_name: prometheus.homelab.com
        backend_host: prometheus.homelab.lan
        backend_port: 9090
        backend_protocol: https

  tasks:
    - name: Install nginx
      ansible.builtin.apt:
        name: nginx
        state: present
        update_cache: true

    - name: Ensure nginx SSL directory exists
      ansible.builtin.file:
        path: /etc/nginx/ssl
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Enable Nginx stub_status for prometheus monitoring
      ansible.builtin.copy:
        dest: /etc/nginx/conf.d/stub_status.conf
        content: |
          server {
              listen 127.0.0.1:8080;
              server_name 127.0.0.1;

              location /stub_status {
                  stub_status on;
                  access_log off;
                  allow 127.0.0.1;
                  deny all;
              }
          }
        owner: root
        group: root
        mode: '0644'
      notify: reload_nginx

    - name: Check if Vault root CA already exists
      ansible.builtin.stat:
        path: /usr/local/share/ca-certificates/vault-root-ca.crt
      register: root_ca_stat

    - name: Download Vault root CA certificate (Internal LAN)
      when: not root_ca_stat.stat.exists
      ansible.builtin.uri:
        url: "https://vault.homelab.lan:8200/v1/root_ca/ca/pem"
        method: GET
        validate_certs: false
        return_content: true
        dest: /usr/local/share/ca-certificates/vault-root-ca.crt

    - name: Update CA certificates
      when: not root_ca_stat.stat.exists
      ansible.builtin.command:
        cmd: update-ca-certificates
      changed_when: true

    - name: Fetch AppRole role_id from Vault
      ansible.builtin.uri:
        url: "https://vault.homelab.lan:8200/v1/auth/approle/role/nginx/role-id"
        method: GET
        headers:
          X-Vault-Token: "{{ vault_token }}"
        validate_certs: true
        return_content: true
      register: nginx_role_id_response

    - name: Generate AppRole secret_id from Vault
      ansible.builtin.uri:
        url: "https://vault.homelab.lan:8200/v1/auth/approle/role/nginx/secret-id"
        method: POST
        headers:
          X-Vault-Token: "{{ vault_token }}"
        validate_certs: false
        return_content: true
      register: nginx_secret_id_response

    - name: Configure Vault Agent for Multiple Certificates
      ansible.builtin.include_role:
        name: vault_agent
      vars:
        # Multi-cert mode: request both wildcard and nginx-specific certificates
        vault_agent_certificates:
          - common_name: "{{ cert_common_name }}"
            filename: "{{ cert_filename }}"
            ttl: "24h"
          - common_name: "nginx.homelab.lan"
            filename: "nginx.homelab.lan"
            ttl: "24h"
        vault_agent_cert_folder: "/etc/nginx/ssl"
        vault_agent_reload_service: "nginx.service"
        vault_agent_role_id: "{{ nginx_role_id_response.json.data.role_id }}"
        vault_agent_secret_id: "{{ nginx_secret_id_response.json.data.secret_id }}"

    - name: Remove default nginx site
      ansible.builtin.file:
        path: /etc/nginx/sites-enabled/default
        state: absent

    - name: Deploy nginx proxy site configurations
      ansible.builtin.template:
        src: templates/nginx-proxy-site.conf.j2
        dest: "/etc/nginx/sites-available/{{ item.server_name }}.conf"
        owner: root
        group: root
        mode: '0644'
      loop: "{{ nginx_proxy_services }}"

    - name: Enable nginx proxy sites
      ansible.builtin.file:
        src: "/etc/nginx/sites-available/{{ item.server_name }}.conf"
        dest: "/etc/nginx/sites-enabled/{{ item.server_name }}.conf"
        state: link
      loop: "{{ nginx_proxy_services }}"

    - name: Deploy nginx direct-access server configuration
      ansible.builtin.template:
        src: templates/nginx-direct-access.conf.j2
        dest: /etc/nginx/sites-available/nginx-direct.conf
        owner: root
        group: root
        mode: '0644'
      notify: reload_nginx

    - name: Enable nginx direct-access site
      ansible.builtin.file:
        src: /etc/nginx/sites-available/nginx-direct.conf
        dest: /etc/nginx/sites-enabled/nginx-direct.conf
        state: link
      notify: reload_nginx

    - name: Enable and start nginx service
      ansible.builtin.systemd:
        name: nginx
        state: started
        enabled: true

    - name: Install and configure node_exporter
      ansible.builtin.include_role:
        name: node_exporter
      vars:
        node_exporter_cert_folder: "/etc/nginx/ssl"
        node_exporter_cert_filename: "nginx.homelab.lan"
        node_exporter_nginx_enabled: true

  handlers:
    - name: reload_nginx
      ansible.builtin.systemd:
        name: nginx
        state: reloaded
