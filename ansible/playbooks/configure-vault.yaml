---
- name: Install Hashicopr Vault
  hosts: vault
  gather_facts: true
  become: false
  roles:
    - zsh
  vars:
    vault_fqdn: "vault.homelab.lan"
    vault_storage_path: /opt/vault/data
    vault_no_log: "{{ vault_secure_log | bool | default(true) }}"

    vault_tls_enabled: "{{ vault_tls | bool | default(true) }}"
    vault_tls_path: "/opt/vault/tls"
    vault_tls_key_file: "/opt/vault/tls/{{ vault_fqdn }}.key"
    vault_tls_fullchain_file: "{{ vault_tls_path }}/{{ vault_fqdn }}.crt"
    vault_addr: "{{ vault_tls_enabled | ternary('https', 'http') }}://{{ vault_fqdn }}:{{ vault_port | default(8200) }}"

    github_org: "LichHunter"
    github_repo: "proxmox-vault"
    github_repo_path: "/root/{{ github_repo }}"
    github_ssh_key_path: "/root/.ssh/github_deploy_key"

  tasks:
    - name: Verify connection to the container
      ansible.builtin.ping:

    - name: Install required packges
      ansible.builtin.apt:
        name:
          - gnupg
          - curl
          - vim
          - socat
        state: present
        update_cache: true

    - name: Add Hashicorp repo
      ansible.builtin.deb822_repository:
        name: hashicorp
        types: [deb]
        uris: "https://apt.releases.hashicorp.com"
        components: [main]
        signed_by: https://apt.releases.hashicorp.com/gpg
        state: present
        enabled: true
        suites: "{{ ansible_facts.distribution_release }}"

    - name: Install vault requirements
      ansible.builtin.apt:
        name:
          - terraform
          - vault
        state: present
        update_cache: true

    - name: Create storage
      ansible.builtin.file:
        name: "{{ vault_storage_path }}"
        owner: vault
        group: vault
        mode: "0755"
        state: directory

    - name: Template vault config
      ansible.builtin.template:
        src: templates/vault.hcl.j2
        dest: /etc/vault.d/vault.hcl

    - name: Start vault service
      ansible.builtin.service:
        name: vault
        enabled: true
        state: restarted

    - name: Check if Vault has already been initialized by looking for the init file
      ansible.builtin.stat:
        path: "{{ vault_storage_path }}/init_data.json"
      register: r_init_data_file

    - name: Read existing Vault init data if it exists
      # The 'slurp' module reads the entire file into a base64 encoded string.
      ansible.builtin.slurp:
        src: "{{ vault_storage_path }}/init_data.json"
      register: r_slurped_data
      # This task only runs if the stat check found the file.
      when: r_init_data_file.stat.exists

    - name: Block to run only when Vault needs to be initialized
      when: not r_init_data_file.stat.exists
      block:
        - name: Initialize Vault for the first time
          ansible.builtin.command:
            cmd: vault operator init -format json
          environment:
            VAULT_ADDR: "{{ vault_addr }}"
          register: r_vault_init
          changed_when: r_vault_init.rc == 0
          failed_when:
            - r_vault_init.rc != 0
            - "'Vault is already initialized' not in r_vault_init.stderr"

        - name: Save the new init data to a file for future runs
          ansible.builtin.copy:
            content: "{{ r_vault_init.stdout | from_json | to_nice_json(indent=2) }}"
            dest: "{{ vault_storage_path }}/init_data.json"
            owner: vault
            group: vault
            mode: '0600'
          when: r_vault_init.changed

    - name: Consolidate Vault init data into a single variable
      ansible.builtin.set_fact:
        vault_init_data: "{{ (r_slurped_data.content | b64decode | from_json) if r_init_data_file.stat.exists else (r_vault_init.stdout | from_json) }}"
      no_log: "{{ vault_no_log | default(true) }}"

    - name: Vault unseal
      loop: "{{ vault_init_data.unseal_keys_b64[:3] }}"
      no_log: "{{ vault_no_log | default(true) }}"
      environment:
        VAULT_ADDR: "{{ vault_addr }}"
      ansible.builtin.command:
        cmd: "vault operator unseal -format json {{ item }}"
      changed_when: false

    - name: Generate SSH key for GitHub access
      community.crypto.openssh_keypair:
        path: "{{ github_ssh_key_path }}"
        type: ed25519
        owner: root
        mode: "0600"

    - name: Read public key for GitHub
      ansible.builtin.slurp:
        src: "{{ github_ssh_key_path }}.pub"
      register: r_ssh_pub_key

    - name: Add deploy key to private GitHub repository
      community.general.github_deploy_key:
        repo: "{{ github_repo }}"
        owner: "{{ github_org }}"
        name: "ansible-vault-bootstrap-{{ ansible_date_time.iso8601 }}"
        key: "{{ r_ssh_pub_key.content | b64decode }}"
        read_only: true
        token: "{{ github_access_token }}"
      delegate_to: localhost
      run_once: true

    - name: Clone private Terraform repository
      ansible.builtin.git:
        repo: "git@github.com:{{ github_org }}/{{ github_repo }}.git"
        dest: "{{ github_repo_path }}"
        version: master
        key_file: "{{ github_ssh_key_path }}"
        accept_newhostkey: true
        force: true

    - name: Template vault terraform variables
      ansible.builtin.template:
        src: templates/vault_terraform_vars.tfvars.j2
        dest: "{{ github_repo_path }}/terraform.tfvars"
      vars:
        vault_tls_enabled: false

    - name: Configure vault using terraform
      community.general.terraform:
        project_path: "{{ github_repo_path }}"
        state: present
        force_init: true
      environment:
        VAULT_ADDR: "http://127.0.0.1:{{ vault_port | default(8200) }}"
        VAULT_TOKEN: "{{ vault_init_data.root_token }}"
      register: r_terraform_apply
      no_log: "{{ vault_no_log | bool }}"

    - name: Fetch AppRole role_id for Vault service
      ansible.builtin.uri:
        url: "http://127.0.0.1:8200/v1/auth/approle/role/vault/role-id"
        method: GET
        headers:
          X-Vault-Token: "{{ vault_init_data.root_token }}"
        return_content: true
      register: vault_role_id_response

    - name: Generate AppRole secret_id for Vault service
      ansible.builtin.uri:
        url: "http://127.0.0.1:8200/v1/auth/approle/role/vault/secret-id"
        method: POST
        headers:
          X-Vault-Token: "{{ vault_init_data.root_token }}"
        return_content: true
      register: vault_secret_id_response

    - name: Configure Vault Agent for Vault service certificates
      ansible.builtin.include_role:
        name: vault_agent
      vars:
        vault_agent_common_name: "vault.homelab.lan"
        vault_agent_cert_filename: "{{ vault_fqdn }}"
        vault_agent_cert_folder: "{{ vault_tls_path }}"
        vault_agent_reload_cmd: "systemctl reload vault || true"
        vault_agent_role_id: "{{ vault_role_id_response.json.data.role_id }}"
        vault_agent_secret_id: "{{ vault_secret_id_response.json.data.secret_id }}"
        vault_agent_vault_addr: "http://127.0.0.1:8200"
        vault_agent_service_user: "vault"
        vault_agent_service_group: "vault"
        vault_agent_cert_perms: "0644"
        vault_agent_key_perms: "0600"

    - name: Restart Vault Agent to generate initial certificates
      ansible.builtin.systemd:
        name: vault-agent
        state: restarted

    - name: Wait for Vault Agent to generate certificates
      ansible.builtin.wait_for:
        path: "{{ vault_tls_path }}/{{ vault_fqdn }}.crt"
        timeout: 60

    - name: Template vault config
      ansible.builtin.template:
        src: templates/vault.hcl.j2
        dest: /etc/vault.d/vault.hcl
      vars:
        vault_tls_enabled: true

    - name: Restart vault service
      ansible.builtin.service:
        name: vault
        enabled: true
        state: restarted

    - name: Re-Unseal Vault over HTTPS
      ansible.builtin.command: "vault operator unseal {{ item }}"
      environment:
        VAULT_ADDR: "https://vault.homelab.lan:{{ vault_port | default(8200) }}"
        VAULT_SKIP_VERIFY: "true"
      loop: "{{ vault_init_data.unseal_keys_b64[:3] }}"
      no_log: "{{ vault_no_log | bool }}"
      changed_when: false

    - name: Template vault terraform variables with TLS
      ansible.builtin.template:
        src: templates/vault_terraform_vars.tfvars.j2
        dest: "{{ github_repo_path }}/terraform.tfvars"
      vars:
        vault_tls_enabled: true

    - name: Configure vault using terraform to use TLS
      community.general.terraform:
        project_path: "{{ github_repo_path }}"
        state: present
        force_init: true
      environment:
        VAULT_ADDR: "https://vault.homelab.lan:{{ vault_port | default(8200) }}"
        VAULT_TOKEN: "{{ vault_init_data.root_token }}"
        VAULT_SKIP_VERIFY: "true"
      register: r_terraform_apply
      no_log: "{{ vault_no_log | bool }}"

    - name: Configure Vault Agent for TLS Vault
      ansible.builtin.include_role:
        name: vault_agent
      vars:
        vault_agent_common_name: "vault.homelab.lan"
        vault_agent_cert_filename: "{{ vault_fqdn }}"
        vault_agent_cert_folder: "{{ vault_tls_path }}"
        vault_agent_reload_cmd: "systemctl reload vault || true"
        vault_agent_role_id: "{{ vault_role_id_response.json.data.role_id }}"
        vault_agent_secret_id: "{{ vault_secret_id_response.json.data.secret_id }}"
        vault_agent_service_user: "vault"
        vault_agent_service_group: "vault"
        vault_agent_cert_perms: "0644"
        vault_agent_key_perms: "0600"

    - name: Vault status
      register: r_vault_status
      no_log: "{{ vault_no_log | default(true) }}"
      environment:
        VAULT_ADDR: "https://vault.homelab.lan:{{ vault_port | default(8200) }}"
      ansible.builtin.command:
        cmd: "vault status -format json"
      changed_when: false

    - name: Vault status report
      ansible.builtin.debug:
        msg: "{{ r_vault_status.stdout | from_json }}"

    - name: Create a local, unencrypted file with the Vault secrets
      ansible.builtin.template:
        src: templates/vault_secrets.yaml.j2
        dest: "../outputs/vault_secrets.yml"
        mode: '0600'
      delegate_to: localhost
